<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <title>Project Zero - Festival</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        /* å¼·åˆ¶å³å´å…§å®¹å€ç‚ºç´”é»‘ä¸¦å¡«æ»¿è¢å¹• */
        .content {
            background-color: #000 !important;
            padding: 0 !important;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        #output_canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ä¿æŒæ”å½±æ©Ÿç•«é¢æ¯”ä¾‹ */
            z-index: 1;
        }

        video { display: none; } /* éš±è—æ”å½±æ©ŸåŸå§‹ç•«é¢ */

        /* æµ®å‹•æç¤ºæ–‡å­— */
        .festival-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .festival-ui h2 {
            color: #00F9C7;
            margin: 0;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .festival-ui p {
            color: #fff;
            font-size: 16px;
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="title">Project Zero / é›¶è¨ˆç•«</div>
    <div class="numbers">Festival Mode</div>
</div>

<div class="layout">
    <div class="sidebar">
        <a href="home.html">è‡ªä»‹</a>
        <a href="diary.html">æ—¥è¨˜</a>
        <a href="blog.html">éƒ¨è½æ ¼</a>
        <a href="gallery.html">ç›¸ç°¿</a>
        <a href="collections.html">æ”¶è—</a>
        <a href="fortune.html">å¹¸é‹æŒ‡æ•¸</a>
        <a href="festival.html">ç¯€æ…¶</a>

        <div id="pixelDog" class="dog-container">
            <img src="GIF_20251224164146204.gif" alt="dog" class="sidebar-dog">
        </div>
    </div>

    <div class="content">
        <div class="festival-ui">
            <h2>2025 New Year Event</h2>
            <p>âœŠ æ¡æ‹³ï¼šç²’å­åŒ¯èšæˆå­—<br>ğŸ–ï¸ å¼µæ‰‹ï¼šç²’å­æ•£é–‹</p>
        </div>
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
    </div>
</div>


    <script>
    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´æ”å½±æ©Ÿ
    async function checkCamera() {
        try {
            await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
            alert("è«‹é–‹å•Ÿæ”å½±æ©Ÿæ¬Šé™ä»¥å•Ÿå‹•ç²’å­äº’å‹•ç‰¹æ•ˆï¼");
        }
    }
    checkCamera();

    // æ ¸å¿ƒå„ªåŒ–ï¼šå³ä½¿æ²’åµæ¸¬åˆ°æ‰‹ï¼Œç²’å­ä¹ŸæœƒæŒçºŒç¹ªè£½
    function drawLoop() {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // å¦‚æœæ²’æœ‰åµæ¸¬åˆ°æ‰‹ï¼Œè®“ target é è¨­åœ¨ç•«é¢ä¸­å¤®
        const defaultX = canvasElement.width / 2;
        const defaultY = canvasElement.height / 2;

        particles.forEach((p, i) => {
            // å¦‚æœæ²’æ¡æ‹³ï¼Œå°±ç¹è‘—ä¸­å¿ƒéš¨æ©Ÿæ¼‚æµ®
            p.update(isFist ? currentHandX : defaultX, isFist ? currentHandY : defaultY, i);
            p.draw();
        });
        requestAnimationFrame(drawLoop);
    }
    drawLoop(); // å•Ÿå‹•å¾ªç’°


    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    let particles = [];
    let textPoints = [];
    let isFist = false;

    // 1. é å…ˆè¨ˆç®— "HAPPY NEW YEAR" çš„åº§æ¨™é»
    function initTextPoints() {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 800;
        tempCanvas.height = 200;
        tCtx.fillStyle = "white";
        tCtx.font = "bold 80px Arial";
        tCtx.textAlign = "center";
        tCtx.fillText("HAPPY NEW YEAR", 400, 110);
        
        const imgData = tCtx.getImageData(0, 0, 800, 200).data;
        for (let y = 0; y < 200; y += 5) {
            for (let x = 0; x < 800; x += 5) {
                if (imgData[(y * 800 + x) * 4 + 3] > 128) {
                    textPoints.push({ x: (x - 400), y: (y - 100) });
                }
            }
        }
    }

    // 2. ç²’å­é¡åˆ¥
    class Particle {
        constructor() {
            this.x = Math.random() * 800;
            this.y = Math.random() * 600;
            this.vx = (Math.random() - 0.5) * 2;
            this.vy = (Math.random() - 0.5) * 2;
            this.color = `hsl(${Math.random() * 50 + 160}, 100%, 70%)`; // è–„è·è‰²ç³»
            this.size = Math.random() * 2 + 1;
        }

        update(targetX, targetY, index) {
            if (isFist) {
                // æ¡æ‹³ï¼šç²’å­ç§»å‹•åˆ°å­—é«”åº§æ¨™
                let pt = textPoints[index % textPoints.length];
                let tx = targetX + pt.x;
                let ty = targetY + pt.y;
                this.x += (tx - this.x) * 0.15;
                this.y += (ty - this.y) * 0.15;
            } else {
                // å¼µæ‰‹ï¼šéš¨æ©Ÿæ¼‚æµ®
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > canvasElement.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvasElement.height) this.vy *= -1;
            }
        }

        draw() {
            canvasCtx.fillStyle = this.color;
            canvasCtx.beginPath();
            canvasCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            canvasCtx.fill();
        }
    }

    // åˆå§‹åŒ–
    initTextPoints();
    for (let i = 0; i < 600; i++) particles.push(new Particle());

    function onResults(results) {
        // è¨­å®š Canvas å¤§å°èˆ‡è¦–çª—ä¸€è‡´
        canvasElement.width = canvasElement.clientWidth;
        canvasElement.height = canvasElement.clientHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        // ç¹ªè£½åŠé€æ˜é»‘è‰² èƒŒæ™¯æ„Ÿ
        canvasCtx.fillStyle = "rgba(0,0,0,0.2)";
        canvasCtx.fillRect(0,0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // åˆ¤æ–·æ¡æ‹³ (é£ŸæŒ‡æŒ‡å°–èˆ‡æŒå¿ƒè·é›¢)
            const d = Math.hypot(landmarks[8].x - landmarks[0].x, landmarks[8].y - landmarks[0].y);
            isFist = d < 0.2; 

            const centerX = (1 - landmarks[9].x) * canvasElement.width; // é¡åƒè™•ç†
            const centerY = landmarks[9].y * canvasElement.height;

            particles.forEach((p, i) => {
                p.update(centerX, centerY, i);
                p.draw();
            });
        }
        canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();
</script>

</body>
</html>
